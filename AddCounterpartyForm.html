<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Counterparty</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .hidden {
            display: none;
        }
        .required-field::after {
            content: "*";
            color: red;
        }
        #accountMessageContainer {
            margin-top: 20px;
            display: none;
        }
        .alert {
            display: block;
        }
        .dropdown-wrapper {
            display: flex;
            align-items: center;
        }
        .refresh-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h3 class="text-center mb-4">Create/Update Counterparty</h3>

    <!-- Account Selector -->
    <div class="mb-3">
        <label for="accountSelector" class="mb-1">Select Account:</label>
        <div class="dropdown-wrapper">
            <select id="accountSelector" class="form-control" onchange="handleSelection()">
                <!-- Options will be populated dynamically -->
            </select>
        </div>
    </div>

    <!-- Message Display -->
    <div id="accountMessageContainer" class="alert" role="alert"></div>

    <!-- Tabs for different counterparty types -->
    <ul class="nav nav-tabs" id="counterpartyTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="individual-tab" data-toggle="tab" href="#individual" role="tab" aria-controls="individual" aria-selected="true">Individual</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="company-tab" data-toggle="tab" href="#company" role="tab" aria-controls="company" aria-selected="false">Company</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="revolut-tab" data-toggle="tab" href="#revolut" role="tab" aria-controls="revolut" aria-selected="false">Revolut Account</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-3">
        <!-- Individual Form -->
        <div class="tab-pane fade show active" id="individual" role="tabpanel" aria-labelledby="individual-tab">
            <form id="individualForm">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="first_name" class="required-field">First Name</label>
                        <input type="text" class="form-control" id="first_name" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="last_name" class="required-field">Last Name</label>
                        <input type="text" class="form-control" id="last_name" required>
                    </div>
                </div>
                <div class="form-group">
                    <h5>Banking Details</h5>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-9">
                        <label for="country" class="required-field">Country</label>
                        <select class="form-control" id="country" required onchange="handleBankCountryChange('individual')"></select>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="currency" class="required-field">Currency</label>
                        <select class="form-control" id="currency" required></select>
                    </div>
                </div>
                <div id="internationalFieldsIndividual" class="form-row">
                    <div class="form-group col-md-8">
                        <label for="individual_ibanInternational">IBAN</label>
                        <input type="text" class="form-control" id="individual_ibanInternational" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="individual_bicInternational">BIC</label>
                        <input type="text" class="form-control" id="individual_bicInternational" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="individual_cityInternational" class="required-field">City</label>
                        <input type="text" class="form-control" id="individual_cityInternational" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="individual_postcodeInternational" class="required-field">Postcode</label>
                        <input type="text" class="form-control" id="individual_postcodeInternational" required>
                    </div>
                </div>
                <div id="ukFieldsIndividual" class="form-row hidden">
                    <div class="form-group col-md-6">
                        <label for="account_no" class="required-field">Account Number</label>
                        <input type="text" class="form-control" id="account_no" placeholder="account shall include 8 digits">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="sort_code" class="required-field">Sort Code</label>
                        <input type="text" class="form-control" id="sort_code" placeholder="expected format: XX-XX-XX">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="uk_street_line1" class="required-field">Street Address</label>
                        <input type="text" class="form-control" id="uk_street_line1">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="uk_city" class="required-field">City</label>
                        <input type="text" class="form-control" id="uk_city" required>
                    </div>
                    <div class="form-group col-md-2">
                        <label for="uk_postcode" class="required-field">Postcode</label>
                        <input type="text" class="form-control" id="uk_postcode" placeholder="UK postcode" required>
                    </div>
                </div>
                <div id="nonEUFieldsIndividual" class="form-row hidden">
                    <div class="form-group col-md-8">
                        <label for="individual_nonEU_iban">IBAN</label>
                        <input type="text" class="form-control" id="individual_nonEU_iban" required>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="individual_nonEU_bic">BIC</label>
                        <input type="text" class="form-control" id="individual_nonEU_bic" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="street_line1" class="required-field">Street Address</label>
                        <input type="text" class="form-control" id="street_line1">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="city" class="required-field">City</label>
                        <input type="text" class="form-control" id="city" required>
                    </div>
                    <div class="form-group col-md-2">
                        <label for="postcode" class="required-field">Postcode</label>
                        <input type="text" class="form-control" id="postcode" required>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitIndividualAccountForm()">Submit Individual</button>
            </form>
        </div>

        <!-- Company Form -->
        <div class="tab-pane fade" id="company" role="tabpanel" aria-labelledby="company-tab">
            <form id="companyForm">
                <div class="form-group">
                    <label for="company_name" class="required-field">Company Name</label>
                    <input type="text" class="form-control" id="company_name" required>
                </div>

                <div class="form-group">
                    <h5>Banking Details</h5>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-9">
                        <label for="companyFormBankCountry" class="required-field">Bank Country</label>
                        <select class="form-control" id="companyFormBankCountry" required onchange="handleBankCountryChange('company')"></select>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="companyFormCurrency" class="required-field">Currency</label>
                        <select class="form-control" id="companyFormCurrency" required></select>
                    </div>
                </div>
                <div id="internationalFieldsCompany" class="form-row">
                    <div class="form-group col-md-8">
                        <label for="company_iban">IBAN</label>
                        <input type="text" class="form-control" id="company_iban">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="company_bic">BIC</label>
                        <input type="text" class="form-control" id="company_bic">
                    </div>
                </div>
                <div id="ukFieldsCompany" class="form-row hidden">
                    <div class="form-group col-md-6">
                        <label for="account_no" class="required-field">Account Number</label>
                        <input type="text" class="form-control" id="account_no" placeholder="account shall include 8 digits">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="sort_code" class="required-field">Sort Code</label>
                        <input type="text" class="form-control" id="sort_code" placeholder="expected format: XX-XX-XX">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="street_line1" class="required-field">Street Address</label>
                        <input type="text" class="form-control" id="street_line1">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="city" class="required-field">City</label>
                        <input type="text" class="form-control" id="city">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="postcode" class="required-field">Postcode</label>
                        <input type="text" class="form-control" id="postcode">
                    </div>
                </div>

                <div id="nonEUFieldsCompany" class="form-row hidden">
                    <div class="form-group col-md-8">
                        <label for="company_iban">IBAN</label>
                        <input type="text" class="form-control" id="iban">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="company_bic">BIC</label>
                        <input type="text" class="form-control" id="bic">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="street_line1" class="required-field">Street Address</label>
                        <input type="text" class="form-control" id="street_line1">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="city" class="required-field">City</label>
                        <input type="text" class="form-control" id="city">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="postcode" class="required-field">Postcode</label>
                        <input type="text" class="form-control" id="postcode">
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitCompanyForm()">Submit Company</button>
            </form>
        </div>

        <!-- Revolut Form -->
        <div class="tab-pane fade" id="revolut" role="tabpanel" aria-labelledby="revolut-tab">
            <form id="revolutForm">
                <div class="form-group">
                    <label for="name" class="required-field">Counterparty Name</label>
                    <input type="text" class="form-control" id="name" required>
                </div>
                <div class="form-group">
                    <label for="revtag" class="required-field">Revtag</label>
                    <input type="text" class="form-control" id="revtag" required>
                </div>
                <div class="form-group">
                    <label for="profile_type" class="required-field">Profile</label>
                    <select class="form-control" id="profile_type" required>
                        <option value="personal">Private Account</option>
                        <option value="business">Corporate Account</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="submitRevolutAccountForm()">Submit</button>
            </form>
        </div>
    </div>
</div>

<script>
    function getISOCountryCodes() {
        return [
            { code: "LU", name: "Luxembourg", ccy: "EUR", geo: "EU" },
            { code: "CH", name: "Switzerland", ccy: "CHF", geo: "Non-EU" },
            { code: "GB", name: "United Kingdom", ccy: "GBP", geo: "UK" },
            { code: "FR", name: "France", ccy: "EUR", geo: "EU" },
            { code: "ES", name: "Spain", ccy: "EUR", geo: "EU" },
            { code: "US", name: "United States", ccy: "USD", geo: "Non-EU" },
            // Additional countries as needed
        ];
    }

    function getGeoRegion() {
        const selectedCountryCode = document.getElementById('country').value;
        const countries = getISOCountryCodes();
        const selectedCountry = countries.find(country => country.code === selectedCountryCode);
        return selectedCountry ? selectedCountry.geo : null;
    }

    function populateDropdown(targetId, data) {
        const dropdown = document.getElementById(targetId);
        dropdown.innerHTML = ''; // Clear existing options

        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.code;
            option.text = item.name;
            dropdown.add(option);
        });
    }

    function populateCurrencyDropdown(targetId, data) {
        const dropdown = document.getElementById(targetId);
        dropdown.innerHTML = ''; // Clear existing options

        const currencies = Array.from(new Set(data.map(country => country.ccy)))
            .map(ccy => ({ code: ccy, name: ccy }));

        currencies.forEach(item => {
            const option = document.createElement('option');
            option.value = item.code;
            option.text = item.name;
            dropdown.add(option);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const countries = getISOCountryCodes();

        // Populate Country and Currency dropdowns
        populateDropdown('country', countries);
        populateDropdown('companyFormBankCountry', countries);
        populateCurrencyDropdown('currency', countries);
        populateCurrencyDropdown('companyFormCurrency', countries);

        loadAccounts();
    });


    function loadAccounts() {
        google.script.run.withSuccessHandler(accounts => {
            const selector = document.getElementById('accountSelector');
            selector.innerHTML = '<option value="all">All</option>';

            if (accounts && accounts.length > 0) {
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account;
                    option.textContent = account;
                    selector.add(option);
                });
                console.log("Accounts loaded:", accounts);
            } else {
                console.log("No accounts found.");
            }
        }).getAccounts();
    }

    function handleSelection() {
        const selectedAccount = document.getElementById('accountSelector').value;
        console.log("Selected account:", selectedAccount);
    }

    function sendDataToAPI(accountName, data) {
        console.log(`Sending data to API (endpoint: counterparty):`, data);

        google.script.run
            .withSuccessHandler(function(response) {
                console.log("Server response:", response);
                // Check if the response contains the "id" field to confirm creation
                if (response.id) {
                    showMessage('Data sent successfully. Counterparty created.', 'success');
                } else {
                    showMessage(response.message || 'An error occurred.', 'warning');
                }
            })
            .withFailureHandler(function(error) {
                console.log("Error from server:", error);
                showMessage(error.message || 'An error occurred.', 'danger');
            })
            .callRevolutAPIMethodPOST('counterparty', accountName, data);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        loadAccounts();
        document.getElementById('accountSelector').addEventListener('change', handleSelection);
    });

    function handleBankCountryChange(type = 'individual') {
        const countryElement = document.getElementById(type === 'individual' ? 'country' : 'companyFormBankCountry');
        const countryCode = countryElement ? countryElement.value : null;

        if (countryCode) {
            const countryInfo = getISOCountryCodes().find(country => country.code === countryCode);
            const geoCategory = countryInfo ? countryInfo.geo : "International";

            const ukFields = document.getElementById(type === 'individual' ? 'ukFieldsIndividual' : 'ukFieldsCompany');
            const nonEUFields = document.getElementById(type === 'individual' ? 'nonEUFieldsIndividual' : 'nonEUFieldsCompany');
            const internationalFields = document.getElementById(type === 'individual' ? 'internationalFieldsIndividual' : 'internationalFieldsCompany');

            if (geoCategory === 'UK' && ukFields) {
                ukFields.classList.remove('hidden');
                nonEUFields?.classList.add('hidden');
                internationalFields?.classList.add('hidden');
            } else if (geoCategory === 'Non-EU' && nonEUFields) {
                ukFields?.classList.add('hidden');
                nonEUFields.classList.remove('hidden');
                internationalFields?.classList.add('hidden');
            } else if (internationalFields) {
                ukFields?.classList.add('hidden');
                nonEUFields?.classList.add('hidden');
                internationalFields.classList.remove('hidden');
            }
        }
    }

    function showMessage(message, type) {
        const messageContainer = document.getElementById('accountMessageContainer');
        messageContainer.className = `alert alert-${type}`;
        messageContainer.textContent = message;
        messageContainer.style.display = 'block';
    }
function submitIndividualAccountForm() {
    console.log("Submit button clicked - initiating submission process.");
    showMessage('Submitting individual account. Please wait...', 'info');

    const accountName = document.getElementById('accountSelector').value;
    if (!accountName || accountName === 'all') {
        showMessage('Please select a valid account.', 'danger');
        return;
    }

    const geo = getGeoRegion();
    console.log("Detected region:", geo);

    // Base data structure
    let data = {
        individual_name: {
            first_name: document.getElementById('first_name').value,
            last_name: document.getElementById('last_name').value
        },
        bank_country: document.getElementById('country').value,
        currency: document.getElementById('currency').value,
        country: document.getElementById('country').value // Root-level country
    };

    // Add address and other fields based on region
    if (geo === 'EU') {
        data.address = {
            city: document.getElementById('individual_cityInternational').value || '',
            street_line1: document.getElementById('street_line1').value || 'na',
            country: document.getElementById('country').value,
            postcode: document.getElementById('individual_postcodeInternational').value || ''
        };
    } else if (geo === 'Non-EU') {
        data.address = {
            city: document.getElementById('city').value || '',
            street_line1: document.getElementById('street_line1').value || 'na',
            country: document.getElementById('country').value,
            postcode: document.getElementById('postcode').value || ''
        };
        data.iban = document.getElementById('individual_nonEU_iban').value || '';
        data.bic = document.getElementById('individual_nonEU_bic').value || '';
    } else if (geo === 'UK') {
        data.account_no = document.getElementById('account_no').value || '';
        data.sort_code = document.getElementById('sort_code').value || '';
        data.address = {
            city: document.getElementById('uk_city').value || '',
            street_line1: document.getElementById('uk_street_line1').value || 'na',
            country: document.getElementById('country').value,
            postcode: document.getElementById('uk_postcode').value || ''
        };
    }

    // Final data check before submission
    console.log("Data prepared for submission (before sending):", JSON.stringify(data));
    sendDataToAPI(accountName, data);
}
</script>

<!-- Include Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>